## Addons
Addons make it possible to easily share common code between applications.

The following walk through will be based on [Creating a datepicker ember addon](http://edgycircle.com/blog/2014-creating-a-datepicker-ember-addon)

This datepicker component uses the [Pikaday](https://github.com/dbushell/Pikaday) library for the datepicker functionality. In addition it includes [Moment.js](http://momentjs.com) so the output format of a date can be adapted.

### Scenarios
The Ember CLI addons API currently supports the following scenarios:

* Performing operations on the `EmberApp` created in the consuming applications `Brocfile.js`
* Adding preprocessors to the default registry
* Providing a custom application tree to be merged with the consuming application
* Providing custom express (server) middlewares

### Addon CLI options
Ember CLI comes has an *addon* command with some options:

```
ember addon <addon-name> <options...>
  Creates a new folder and runs ember init in it.
  --dry-run (Default: false)
  --verbose (Default: false)
  --blueprint (Default: addon)
  --skip-npm (Default: false)
  --skip-bower (Default: false)
  --skip-git (Default: false)
```

Note that an addon can NOT be created inside an existing application.
This is to ensure that your addon is developed (and runs) in isolation and doesn't `require` any application files.

### Create addon

To create a basic addon:

`ember addon <addon-name>`

Running this command should generate something like the following:

```
ember addon my-addon
version: 0.0.44
installing
  create .bowerrc
  create .editorconfig
  create tests/dummy/.jshintrc
  create .travis.yml
  create Brocfile.js
  create README.md

  create tests/dummy/app/app.js
  ... more test files

  create bower.json
  create .gitignore
  create package.json  

  ...
  create vendor/.gitkeep
  create addon/.gitkeep
  create app/.gitkeep
  create index.js

Installing packages for tooling via npm
Installed browser packages via Bower. 
```

### Create blueprint

A blueprint is a bundle of template files with optional install logic.
For more details see [[generators-and-blueprints]])

To create a *blueprint* addon:

`ember addon <blueprint-name> --blueprint`

A blueprint should: 

- have an npm keyword `ember-blueprint`
- have a `blueprints` folder in the project root
- See _Blueprints_ section below

Note: You can also add a blueprint to an addon manually.

### Project structure conventions

The addon project created follows some structure conventions:

`app/` - compiled/merged into the application's namespace. 

`addon/` - compiled/merged into the addon's namespace.

`blueprints/` - blueprints that come with the addon

`tests/` - test infrastructure including a "dummy" app and acceptance test helpers.

`vendor/` - vendor specific files

`Brocfile.js` - Compilation configuration
`package.json` - Node meta-data, dependencies etc.
`index.js` - main Node entry point (as per npm conventions)

### Discovery
Ember CLI detects the presence of an addon by inspecting each of your applications dependencies and searching their `package.json` files for the presence of `ember-addon` in the `keywords` section.

### Installation
Any addon can be installed simply via

`npm install --save-dev <package name>`

### Package.json
The generated addon `package.json` file looks something like this:

```json
{
  "name": "ember-pikaday", // name
  "version": "0.0.0", // versioning
  "directories": {
    "doc": "doc",
    "test": "test"
  },
  "scripts": {
    "start": "ember server",
    "build": "ember build",
    "test": "ember test"
  },
  "repository": "https://github.com/repo-user/my-addon",
  "engines": {
    "node": ">= 0.10.0"
  },
  "keywords": [
    "ember-addon"
    // add more keywords to better categorize the addon 
  ],
  "ember-addon": {
    // addon configuration properties
    "configPath": "tests/dummy/config"
  },
  "author": "", // your name
  "license": "MIT", // license
  "devDependencies": {
    "body-parser": "^1.2.0",
    ... // add specific dev dependencies here!
}
```

Let's add some meta data to categorize the addon a little better:

```json
  "keywords": [
    "ember-addon"
    "pikaday",
    "datepicker"
    "moment"
    "time"
    "date"
  ],
```

You can provide a custom entry point by specifying a `main` property in your `package.json` for the `"ember-addon"` key as illustrated here:

```json
"ember-addon": {
  "main": "lib/ember-addon-main.js", // custom main file
  "configPath": "tests/dummy/config"
}
```

### Addon entry point
By default the addon will use standard *Node.js* require rules, so it will look for an `index.js` file in the project root. 

The generated default addon file `index.js` is a simple Javascript Object (POJO) that you can customize and expand as you see fit.

```javascript
// index.js
module.exports = {
  name: 'my-addon'
};
```

### Project
Ember CLI will create a new instance of the class that your addon returns passing it the `Project` instance for the current project (See Customization section below). 

### Managing dependencies

Installed your client side dependencies via Bower.
Here we install `Pikaday` and `Moment.js`:

```
bower install --save-dev pikaday
bower install --save-dev momentjs
```

Adds bower components to development dependencies

```json
  // bower.js
{
  "name": "ember-pikaday",
  "dependencies": {
    // ...
  },
  "devDependencies": {
    "pikaday": "~1.2.0",
    "momentjs": "~2.8.3"
  }
```

Now run `bower install` to install them.

To make them available in the dummy application and tests, add the relevant import statements to the `Brocfile.js`.

```javascript
app.import('bower_components/momentjs/moment.js');
app.import('bower_components/pikaday/pikaday.js');
app.import('bower_components/pikaday/css/pikaday.css');

module.exports = app.toTree();
```

In order to allow the consuming application to use the component without manual import statements, put the component under the `app/components` directory.  

```javascript
// app/components/pikaday-input.js
 
import Ember from 'ember';
import PikadayInputComponent from 'ember-pikaday/components/pikaday-input';
 
export default PikadayInputComponent;
```

The code imports the component from the addon directory and exports it again. This setup allows others to modify the component by extending it while making the component available in the consuming applications namespace.

The actual code for the addon goes in `addon/components/pikaday-input.js`
Here is an example of a typical component structure.

```javascript
import Ember from 'ember';

export default Ember.Component.extend({
  tagName: 'input',

  setupPikaday: function() {
    // ...
  }.on('didInsertElement'),

  teardownPikaday: function() {
    this.get('pikaday').destroy();
  }.on('willDestroyElement'),
});
```

### Blueprints

To create a blueprint, add a file `blueprints/ember-pikaday.js`. This follows the usual Ember blueprints naming conventions. 

Then use `addBowerPackageToProject` in the `afterInstall` hook to add the required dependencies to the project. 

```javascript
// blueprints/ember-pikaday
module.exports = {
  normalizeEntityName: function() {},

  afterInstall: function() {
    var that = this;

    return this.addBowerPackageToProject('pikaday').then(function() {
        return that.addBowerPackageToProject('momentjs');
    });
  }
};
```

Now make sure the dependency files are imported into the consuming application.

In the entry point of the addon (`index.js`), use the `included` hook to import the files in the correct order. 

```javascript
module.exports = {
  name: 'ember-pikaday',
  included: function(app) {
    this._super.included(app);

    // Note: same as in Brocfile, not very DRY
    app.import('bower_components/momentjs/moment.js');
    app.import('bower_components/pikaday/pikaday.js');
    app.import('bower_components/pikaday/css/pikaday.css');
  }
};
```

In the example file, the `included` hook is used. This hook is called by the `EmberApp` constructor and gives access to the app as `app`. 

When the consuming application's `Brocfile.js` is processed by Ember CLI to build/serve etc. the addon's `included` function is called passing the `EmberApp` instance.

### Testing
The addon project contains a `/tests` folder which contains the necessary infrastructure to run and configure tests for the addon.
The `/tests` folder has the following structure:

- `/dummy`
- `/helpers`
- `/unit`
- `index.html`
- `test_helper.js`

The `/dummy` folder contains the basic layout of a dummy app to be used for to host your addon for testing. 

The `/helpers` folder contains various *qunit* helpers that are provided and those you define yourself in order to keep your tests concise.

The `/helpers` folder should contain your unit tests that test your addon in various usage scenarios. These test may also be full integration tests that test the addon being hosted in the dummy app...

`test_helper.js` is the main helper file that you should reference from any of your unit test files. It imports the `resolver` helper found in `/helpers` used to resolve pages in the `dummy` app.

`index.html` contains the test page that you can load in a browser to display the results of running the unit tests.

### Writing acceptance tests

The following is an example of a simple *Qunit* acceptance test, placed in `tests/unit/components`.

```javascript
// tests/unit/components/pikaday-input-test.js

import { test, moduleForComponent } from 'ember-qunit';
import startApp from '../../helpers/start-app';
import Ember from 'ember';

var App;

moduleForComponent('pikaday-input', 'PikadayInputComponent', {
  setup: function() {
    App = startApp();
  },
  teardown: function() {
    Ember.run(App, 'destroy');
  }
});

test('is an input tag', function() {
  equal('INPUT', this.$().prop('tagName'));

  this.subject().teardownPikaday();
});

// more tests follow...
```

For how to run and configure tests, see the Ember CLI *Testing* section.

### Publish addon

Use *npm* and *git* to publish the addon like a normal npm package.

```
npm version 0.0.1
git push origin master
git push origin --tags
npm publish
```

### Install and use addon

Now you can install your addon with: 

`npm install ember-cli-<your-addon-name-here> --save-dev`.

For our component/blueprint example:

`npm install --save-dev ember-pikaday`  

Run the blueprint generator via

`ember g ember-pikaday`

Enjoy :)
